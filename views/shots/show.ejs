<%- layout('layouts/boilerplate') %>

<div class="shot-detail-wrapper">
  <div class="shot-detail-container">
    <div class="shot-navigation">
      <a href="/shot" class="back-link">
        <svg class="back-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        Back to Homepage
      </a>
    </div>

    <div class="shot-showcase">
      <div class="shot-image-container">
        <img src="<%= shot.image %>" alt="<%= shot.title %>" class="showcase-image" />
      </div>

      <div class="shot-info-section">
        <div class="shot-header-content">
          <div class="title-area">
            <h1 class="showcase-title"><%= shot.title %></h1>

            <div class="stat-badge-header">
              <div class="stat-badge views-badge">
                <i class="fa-solid fa-eye stat-icon-views"></i>
                <span class="stat-number"><%= shot.views || 0 %></span>
              </div>

              <% if (currUser) { %>
              <div class="stat-badge thumbs-badge <%= isLiked ? 'liked' : '' %>" onclick="toggleThumbs(this)">
                <i
                  class="<%= isLiked ? 'fa-solid' : 'fa-regular' %> fa-thumbs-up stat-icon-likes"
                  id="thumbsIcon"
                  <% if (isLiked) { %> style="color:#123ac0;" <% } %>
                ></i>
                <span class="stat-number" id="thumbsCount"><%= shot.likes || 0 %></span>
              </div>
              <% } else { %>
              <div class="stat-badge thumbs-badge" onclick="showLoginMessage()">
                <i class="fa-regular fa-thumbs-up stat-icon-likes"></i>
                <span class="stat-number"><%= shot.likes || 0 %></span>
              </div>
              <% } %>
            </div>
          </div>

          <h1 class="author-name-mini">
            Shot By :
            <a href="/user/<%= shot.author.id %>"><%= shot.author.username %></a>
          </h1>

          <% if (currUser && currUser.id == shot.author.id) { %>
          <div class="action-buttons">
            <a href="/shot/<%= shot._id %>/edit" class="action-btn edit-btn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" />
              </svg>
              Edit
            </a>

            <form
              class="delete-action"
              action="/shot/<%= shot._id %>?_method=DELETE"
              method="POST"
              onsubmit="return confirm('Are you sure you want to delete this shot?')"
            >
              <button type="submit" class="action-btn delete-btn">
                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3,6 5,6 21,6" />
                  <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2 2V6" />
                </svg>
                Delete
              </button>
            </form>
          </div>
          <% } %>

          <% if (shot.description) { %>
          <div class="description-section">
            <div class="showcase-description">
              <% if (shot.tags && shot.tags.length > 0) { %>
                <% shot.tags.forEach(tag => { %>
                  <span>#<%= tag %> &nbsp;</span>
                <% }) %>
                <br />
              <% } %>
              <%= shot.description %>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </div>

    <div class="reviews-section">
      <div class="reviews-header">
        <h2 class="reviews-title">Reviews</h2>
        <span class="reviews-count"><%= shot.reviews.length %> reviews</span>
      </div>

      <% if (currUser) { %>
      <div class="add-review-container">
        <div class="user-avatar-small">
          <i class="fa-solid fa-user"></i>
        </div>
        <form class="review-form" action="/review/<%-shot._id%>" method="post">
          <textarea class="review-input" name="review[comment]" placeholder="Share your thoughts about this shot..." rows="3"></textarea>
          <div class="review-form-actions">
            <input type="hidden" name="review[rating]" id="ratingInput" value="1">
            <div class="rating-selector">
              <span class="rating-label">Rating:</span>
              <div class="star-rating">
                <i class="fa-solid fa-star star-icon" data-rating="1"></i>
                <i class="fa-regular fa-star star-icon" data-rating="2"></i>
                <i class="fa-regular fa-star star-icon" data-rating="3"></i>
                <i class="fa-regular fa-star star-icon" data-rating="4"></i>
                <i class="fa-regular fa-star star-icon" data-rating="5"></i>
              </div>
            </div>
            <button type="submit" class="submit-review-btn">Post Review</button>
          </div>
        </form>
      </div>
      <% } else { %>
      <div class="login-prompt-reviews">
        <p>Please <a href="/user/login">log in</a> to leave a review</p>
      </div>
      <% } %>

      <div class="reviews-list">
        <% shot.reviews.forEach((review, index) => { %>
          <div class="review-item">
            <div class="review-header">
              <div class="reviewer-info">
                <div class="user-avatar"><i class="fa-solid fa-user"></i></div>
                <div class="reviewer-details">
                  <h4 class="reviewer-name"><%= review.owner.username %></h4>
                </div>
              </div>
              <div class="review-actions">
                <div class="review-rating">
                  <% for(let i=0; i<review.rating; i++) { %>
                    <i class="fa-solid fa-star star-filled"></i>
                  <% } %>
                  <% for(let emptyStars = review.rating; emptyStars<5; emptyStars++) { %>
                    <i class="fa-regular fa-star"></i>
                  <% } %>
                </div>
                <% if (currUser && (currUser.id == review.owner._id.toString() || currUser.id == shot.author.id.toString())) { %>
                  <form class="delete-review-form" action="/review/<%= shot._id %>/<%= review._id %>?_method=DELETE" method="POST">
                    <button type="submit" class="review-delete-btn" title="Delete Review" onclick="return confirm('Are you sure you want to delete this review?')">
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
            <p class="review-text">
              <%= review.comment %>
            </p>
          </div>
        <% }) %>
      </div>
    </div>
  </div>
</div>

<script>
window.toggleThumbs = async function (el) {
  const icon = el.querySelector("#thumbsIcon");
  const count = el.querySelector("#thumbsCount");
  const shotId = "<%= shot._id %>";

  try {
    const res = await fetch(`/shot/${shotId}/stat/likes`, {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    });
    if (!res.ok) return;
    const data = await res.json();

    icon.classList.toggle("fa-solid", data.isLiked);
    icon.classList.toggle("fa-regular", !data.isLiked);
    icon.style.color = data.isLiked ? "#123ac0" : "";
    el.classList.toggle("liked", data.isLiked);
    count.textContent = data.likes || 0;
    icon.style.transform = "scale(1.2)";
    setTimeout(() => (icon.style.transform = "scale(1)"), 150);
  } catch (e) {
    console.error("Like toggle error", e);
  }
};

let selectedRating = 0;
const starIcons = document.querySelectorAll(".star-icon");
const ratingInput = document.getElementById("ratingInput");
starIcons.forEach((star, index) => {
  star.addEventListener("click", function () {
    const rating = parseInt(this.getAttribute("data-rating"));
    ratingInput.value = rating;
    selectedRating = rating;
    starIcons.forEach((s, i) => {
      if (i < rating) {
        s.classList.remove("fa-regular");
        s.classList.add("fa-solid");
      } else {
        s.classList.remove("fa-solid");
        s.classList.add("fa-regular");
      }
    });
  });

  star.addEventListener("mouseenter", function () {
    const rating = parseInt(this.getAttribute("data-rating"));
    starIcons.forEach((s, i) => {
      if (i < rating) s.style.transform = "scale(1.2)";
    });
  });

  star.addEventListener("mouseleave", function () {
    starIcons.forEach(s => (s.style.transform = "scale(1)"));
  });
});
</script>
